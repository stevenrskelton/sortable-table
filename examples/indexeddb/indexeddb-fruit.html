<link rel="import" href="../../polymer/polymer.html">

<polymer-element hidden
	name="indexeddb-fruit"
	attributes="url withCredentials start length search sortColumn sortDescending columns data dataSize loading"
>
<script>
	"use strict";
	Polymer({
		url: null,
		withCredentials: false,
		start: 0,
		length: -1,
		search: "",
		sortColumn: null,
		sortDescending: false,
		db: null,
		loading: false,
		openTransactionCount: 0,
		created: function(){
			if(!this.columns) this.columns = [];
		},
		ready: function() {
			var self = this;
			var dbVersion = 15;
			var dbFieldLabels = ["name","Water (g)","Energy (kcal)","Protein (g)","Fat, total (g)","Carbohydrate (g)","Sugars, total (g)","Fiber, total dietary (g)","Alcohol (g)","Cholesterol (mg)","Saturated fatty acids, total (g)","Monounsaturated fatty acids, total (g)","Polyunsaturated fatty acids, total (g)","Calcium (mg)","Copper (mg)","Iron (mg)","Magnesium (mg)","Phosphorus (mg)","Potassium (mg)","Selenium (mcg)","Sodium (mg)","Zinc (mg)","Vitamin A, RAE (mcg)","Vitamin C (mg)","Vitamin B-6 (mg)","Vitamin B-12 (mcg)","Vitamin B-12, added (mcg)","Vitamin E, alpha tocopherol (mg)","Vitamin E, added (mg)","Folate, total (mcg)","Folic acid (mcg)","Vitamin K (mcg)","Niacin (mg)","Retinol (mcg)","Riboflavin (mg)","Thiamin (mg)","Carotene, beta (mcg)","Carotene, alpha (mcg)","Cryptoxanthin, beta (mcg)","Lutein + zeaxanthin (mcg)","Lycopene (mcg)","Caffeine (mg)","Theobromine"];
			var dbFields = ["name","water","energy","protein","fat","carbohydrates","sugars","fiber","alcohol","cholesterol","saturatedfats","monounsaturatedfats","polyunsaturatedfats","calcium","copper","iron","magnesium","phosphorus","potassium","selenium","sodium","zinc","vitamina","vitaminc","vitaminb6","vitaminb12","vitaminb12a","vitamine","vitaminea","folatet","folic","vitamink","niacin","retinol","riboflavin","thiamin","carotenebeta","carotenealpha","cryptoxanthin","lutein","lycopene","caffeine","theobromine"];
			var request = indexedDB.open("fruits", dbVersion);
			request.onupgradeneeded = function(event) {
				var db = event.target.result;
				if(db.objectStoreNames.contains('fruits')) db.deleteObjectStore("fruits");
				var objectStore = db.createObjectStore("fruits", { autoIncrement: true });
				objectStore.createIndex("name", dbFields[0], { unique: true });
				objectStore.createIndex("energy", dbFields[2], { unique: false });
				objectStore.createIndex("protein", dbFields[3], { unique: false });
				objectStore.createIndex("fat", dbFields[4], { unique: false });
				objectStore.createIndex("carbohydrates", dbFields[5], { unique: false });
				objectStore.transaction.oncomplete = function(event) {
					// Store values in the newly created objectStore.
					var fruitsObjectStore = db.transaction("fruits", "readwrite").objectStore("fruits");
					//This data could come from anywhere, including a compressed file
					var dbData = [
						["Acerola",94.3,23,0.4,0.3,4.8,4.5,0.3,0,0,0.068,0.082,0.09,10,0.086,0.5,12,9,97,0.1,3,0.1,25,1600,0.004,0,0,0.18,0,14,0,1.4,0.4,0,0.06,0.02,305,0,0,17,0,0,0],
						["Apple",85.56,52,0.26,0.17,13.81,10.39,2.4,0,0,0.028,0.007,0.051,6,0.027,0.12,5,11,107,0,1,0.04,3,4.6,0.041,0,0,0.18,0,3,0,2.2,0.091,0,0.026,0.017,27,0,11,29,0,0,0],
						["Apricot",86.35,48,1.4,0.39,11.12,9.24,2,0,0,0.027,0.17,0.077,13,0.078,0.39,10,23,259,0.1,1,0.2,96,10,0.054,0,0,0.89,0,9,0,3.3,0.6,0,0.04,0.03,1094,19,104,89,0,0,0],
						["Avocado",73.23,160,2,14.66,8.53,0.66,6.7,0,0,2.126,9.799,1.816,12,0.19,0.55,29,52,485,0.4,7,0.64,7,10,0.257,0,0,2.07,0,81,0,21,1.738,0,0.13,0.067,62,24,28,271,0,0,0],
						["Banana",74.91,89,1.09,0.33,22.84,12.23,2.6,0,0,0.112,0.032,0.073,5,0.078,0.26,27,22,358,1,1,0.15,3,8.7,0.367,0,0,0.1,0,20,0,0.5,0.665,0,0.073,0.031,26,25,0,22,0,0,0],
						["Blackberries",88.15,43,1.39,0.49,9.61,4.88,5.3,0,0,0.014,0.047,0.28,29,0.165,0.62,20,22,162,0.4,1,0.53,11,21,0.03,0,0,1.17,0,25,0,19.8,0.646,0,0.026,0.02,128,0,0,118,0,0,0],
						["Blueberries",84.21,57,0.74,0.33,14.49,9.96,2.4,0,0,0.028,0.047,0.146,6,0.057,0.28,6,12,77,0.1,1,0.16,3,9.7,0.052,0,0,0.57,0,6,0,19.3,0.418,0,0.041,0.037,32,0,0,80,0,0,0],
						["Calamondin",85.17,53,0.81,0.31,13.34,10.58,1.8,0,0,0.039,0.06,0.065,37,0.042,0.15,12,20,166,0.1,2,0.07,34,26.7,0.078,0,0,0.2,0,16,0,0,0.376,0,0.036,0.058,155,101,407,138,0,0,0],
						["Cantaloupe",90.15,34,0.84,0.19,8.16,7.86,0.9,0,0,0.051,0.003,0.081,9,0.041,0.21,12,15,267,0.4,16,0.18,169,36.7,0.072,0,0,0.05,0,21,0,2.5,0.734,0,0.019,0.041,2020,16,1,26,0,0,0],
						["Cherries sweet",82.25,63,1.06,0.2,16.01,12.82,2.1,0,0,0.038,0.047,0.052,13,0.06,0.36,11,21,222,0,0,0.07,3,7,0.049,0,0,0.07,0,4,0,2.1,0.154,0,0.033,0.027,38,0,0,85,0,0,0],
						["Clementine",85.17,53,0.81,0.31,13.34,10.58,1.8,0,0,0.039,0.06,0.065,37,0.042,0.15,12,20,166,0.1,2,0.07,34,26.7,0.078,0,0,0.2,0,16,0,0,0.376,0,0.036,0.058,155,101,407,138,0,0,0],
						["Coconut meat",46.99,354,3.33,33.49,15.23,6.23,9,0,0,29.698,1.425,0.366,14,0.435,2.43,32,113,356,10.1,20,1.1,0,3.3,0.054,0,0,0.24,0,26,0,0.2,0.54,0,0.02,0.066,0,0,0,0,0,0,0],
						["Coconut milk",67.62,230,2.29,23.84,5.54,3.34,2.2,0,0,21.14,1.014,0.261,16,0.266,1.64,37,100,263,6.2,15,0.67,0,2.8,0.033,0,0,0.15,0,16,0,0.1,0.76,0,0,0.026,0,0,0,0,0,0,0],
						["Coconut water",94.99,19,0.72,0.2,3.71,2.61,1.1,0,0,0.176,0.008,0.002,24,0.04,0.29,25,20,250,1,105,0.1,0,2.4,0.032,0,0,0,0,3,0,0,0.08,0,0.057,0.03,0,0,0,0,0,0,0],
						["Cranberries",87.13,46,0.39,0.13,12.2,4.04,4.6,0,0,0.011,0.018,0.055,8,0.061,0.25,6,13,85,0.1,2,0.1,3,13.3,0.057,0,0,1.2,0,1,0,5.1,0.101,0,0.02,0.012,36,0,0,91,0,0,0],
						["Date",20.53,282,2.45,0.39,75.03,63.35,8,0,0,0.032,0.036,0.019,39,0.206,1.02,43,62,656,3,2,0.29,0,0.4,0.165,0,0,0.05,0,19,0,2.7,1.274,0,0.066,0.052,6,0,0,75,0,0,0],
						["Fig",79.11,74,0.75,0.3,19.18,16.26,2.9,0,0,0.06,0.066,0.144,35,0.07,0.37,17,14,232,0.2,1,0.15,7,2,0.113,0,0,0.11,0,6,0,4.7,0.4,0,0.05,0.06,85,0,0,9,0,0,0],
						["Grapes",80.54,69,0.72,0.16,18.1,15.48,0.9,0,0,0.054,0.007,0.048,10,0.127,0.36,7,20,191,0.1,2,0.07,3,10.8,0.086,0,0,0.19,0,2,0,14.6,0.188,0,0.07,0.069,39,1,0,72,0,0,0],
						["Grapefruit",90.89,32,0.63,0.1,8.08,6.98,1.1,0,0,0.014,0.013,0.024,12,0.047,0.09,8,8,139,0.3,0,0.07,46,34.4,0.042,0,0,0.13,0,10,0,0,0.25,0,0.02,0.036,552,4,6,6,1135,0,0],
						["Guava",80.8,68,2.55,0.95,14.32,8.92,5.4,0,0,0.272,0.087,0.401,18,0.23,0.26,22,40,417,0.6,2,0.23,31,228.3,0.11,0,0,0.73,0,49,0,2.6,1.084,0,0.04,0.067,374,0,0,0,5204,0,0],
						["Honeydew melon, Melon",89.82,36,0.54,0.14,9.09,8.12,0.8,0,0,0.038,0.003,0.059,6,0.024,0.17,10,11,228,0.7,18,0.09,3,18,0.088,0,0,0.02,0,19,0,2.9,0.418,0,0.012,0.038,30,0,0,27,0,0,0],
						["Huckleberries",84.21,57,0.74,0.33,14.49,9.96,2.4,0,0,0.028,0.047,0.146,6,0.057,0.28,6,12,77,0.1,1,0.16,3,9.7,0.052,0,0,0.57,0,6,0,19.3,0.418,0,0.041,0.037,32,0,0,80,0,0,0],
						["Kiwi fruit",83.07,61,1.14,0.52,14.66,8.99,3,0,0,0.029,0.047,0.287,34,0.13,0.31,17,34,312,0.2,3,0.14,4,92.7,0.063,0,0,1.46,0,25,0,40.3,0.341,0,0.025,0.027,52,0,0,122,0,0,0],
						["Kumquat",80.85,71,1.88,0.86,15.9,9.36,6.5,0,0,0.103,0.154,0.171,62,0.095,0.86,20,19,186,0,10,0.17,15,43.9,0.036,0,0,0.15,0,17,0,0,0.429,0,0.09,0.037,0,155,193,129,0,0,0],
						["Lemon",88.98,29,1.1,0.3,9.32,2.5,2.8,0,0,0.039,0.011,0.089,26,0.037,0.6,8,16,138,0.4,2,0.06,1,53,0.08,0,0,0.15,0,11,0,0,0.1,0,0.02,0.04,3,1,20,11,0,0,0],
						["Lime, Lima, Limon",88.26,30,0.7,0.2,10.54,1.69,2.8,0,0,0.022,0.019,0.055,33,0.065,0.6,6,18,102,0.4,2,0.11,2,29.1,0.043,0,0,0.22,0,8,0,0.6,0.2,0,0.02,0.03,30,0,0,0,0,0,0],
						["Loganberries",84.61,55,1.52,0.31,13.02,7.7,5.3,0,0,0.011,0.03,0.176,26,0.117,0.64,21,26,145,0.2,1,0.34,2,15.3,0.065,0,0,0.87,0,26,0,7.8,0.84,0,0.034,0.05,21,0,0,118,0,0,0],
						["Lychee",81.76,66,0.83,0.44,16.53,15.23,1.3,0,0,0.099,0.12,0.132,5,0.148,0.31,10,31,171,0.6,1,0.07,0,71.5,0.1,0,0,0.07,0,14,0,0.4,0.603,0,0.065,0.011,0,0,0,0,0,0,0],
						["Mango",81.71,65,0.51,0.27,17,14.8,1.8,0,0,0.066,0.101,0.051,10,0.11,0.13,9,11,156,0.6,2,0.04,38,27.7,0.134,0,0,1.12,0,14,0,4.2,0.584,0,0.057,0.058,445,17,11,0,0,0,0],
						["Mulberries",87.68,43,1.44,0.39,9.8,8.1,1.7,0,0,0.027,0.041,0.207,39,0.06,1.85,18,38,194,0.6,10,0.12,1,36.4,0.05,0,0,0.87,0,6,0,7.8,0.62,0,0.101,0.029,9,12,0,136,0,0,0],
						["Pear, Asian",88.25,42,0.5,0.23,10.65,7.05,3.6,0,0,0.012,0.049,0.055,4,0.05,0,8,11,121,0.1,0,0.02,0,3.8,0.022,0,0,0.12,0,8,0,4.5,0.219,0,0.01,0.009,0,0,0,50,0,0,0],
						["Orange",86.75,47,0.94,0.12,11.75,9.35,2.4,0,0,0.015,0.023,0.025,40,0.045,0.1,10,14,181,0.5,0,0.07,11,53.2,0.06,0,0,0.18,0,30,0,0,0.282,0,0.04,0.087,71,11,116,129,0,0,0],
						["Papaya",88.83,39,0.61,0.14,9.81,5.9,1.8,0,0,0.043,0.038,0.031,24,0.016,0.1,10,5,257,0.6,3,0.07,55,61.8,0.019,0,0,0.73,0,38,0,2.6,0.338,0,0.032,0.027,276,0,761,75,0,0,0],
						["Passion fruit",72.93,97,2.2,0.7,23.38,11.2,10.4,0,0,0.059,0.086,0.411,12,0.086,1.6,29,68,348,0.6,28,0.1,64,30,0.1,0,0,0.02,0,14,0,0.7,1.5,0,0.13,0,743,0,41,0,0,0,0],
						["Peach",88.87,39,0.91,0.25,9.54,8.39,1.5,0,0,0.019,0.067,0.086,6,0.068,0.25,9,20,190,0.1,0,0.17,16,6.6,0.025,0,0,0.73,0,4,0,2.6,0.806,0,0.031,0.024,162,0,67,91,0,0,0],
						["Pear",83.71,58,0.38,0.12,15.46,9.8,3.1,0,0,0.006,0.026,0.029,9,0.082,0.17,7,11,119,0.1,1,0.1,1,4.2,0.028,0,0,0.12,0,7,0,4.5,0.157,0,0.025,0.012,13,0,2,45,0,0,0],
						["Persimmon",80.32,70,0.58,0.19,18.59,12.53,3.6,0,0,0.02,0.037,0.043,8,0.113,0.15,9,17,161,0.6,1,0.11,81,7.5,0.1,0,0,0.73,0,8,0,2.6,0.1,0,0.02,0.03,253,0,1447,834,159,0,0],
						["Pineapple",86.46,48,0.54,0.12,12.63,9.26,1.4,0,0,0.009,0.014,0.042,13,0.099,0.28,12,8,115,0.1,1,0.1,3,36.2,0.11,0,0,0.02,0,15,0,0.7,0.489,0,0.031,0.079,34,0,0,0,0,0,0],
						["Plantain",65.28,122,1.3,0.37,31.89,15,2.3,0,0,0.143,0.032,0.069,3,0.081,0.6,37,34,499,1.5,4,0.14,56,18.4,0.299,0,0,0.14,0,22,0,0.7,0.686,0,0.054,0.052,457,438,0,30,0,0,0],
						["Plum",87.23,46,0.7,0.28,11.42,9.92,1.4,0,0,0.017,0.134,0.044,6,0.057,0.17,7,16,157,0,0,0.1,17,9.5,0.029,0,0,0.26,0,5,0,6.4,0.417,0,0.026,0.028,190,0,35,73,0,0,0],
						["Pomegranate",80.97,68,0.95,0.3,17.17,16.57,0.6,0,0,0.038,0.046,0.063,3,0.07,0.3,3,8,259,0.6,3,0.12,5,6.1,0.105,0,0,0.6,0,6,0,4.6,0.3,0,0.03,0.03,40,50,0,0,0,0,0],
						["Raspberries",85.75,52,1.2,0.65,11.94,4.42,6.5,0,0,0.019,0.064,0.375,25,0.09,0.69,22,29,151,0.2,1,0.42,2,26.2,0.055,0,0,0.87,0,21,0,7.8,0.598,0,0.038,0.032,12,16,0,136,0,0,0],
						["Soursop nectar",83.11,64,0.15,0.04,16.52,16.02,0.5,0,0,0.008,0.014,0.01,4,0.017,0.09,4,4,38,0.2,4,0.02,0,2.2,0.008,0,0,0.01,0,1,0,0.1,0.122,0,0.009,0.008,0,0,0,0,0,0,0],
						["Strawberries",90.95,32,0.67,0.3,7.68,4.66,2,0,0,0.015,0.043,0.155,16,0.048,0.42,13,24,153,0.4,1,0.14,1,58.8,0.047,0,0,0.29,0,24,0,2.2,0.386,0,0.022,0.024,7,0,0,26,0,0,0],
						["Tamarind",31.4,239,2.8,0.6,62.5,57.4,5.1,0,0,0.272,0.181,0.059,74,0.086,2.8,92,113,628,1.3,28,0.1,2,3.5,0.066,0,0,0.1,0,14,0,2.8,1.938,0,0.152,0.428,18,0,0,0,0,0,0],
						["Tomato",94.5,18,0.88,0.2,3.92,2.63,1.2,0,0,0.046,0.051,0.135,10,0.059,0.27,11,24,237,0,5,0.17,42,12.7,0.08,0,0,0.54,0,15,0,7.9,0.594,0,0.019,0.037,449,101,0,123,2573,0,0],
						["Watermelon",91.45,30,0.61,0.15,7.55,6.2,0.4,0,0,0.016,0.037,0.05,7,0.042,0.24,10,11,112,0.4,1,0.1,28,8.1,0.045,0,0,0.05,0,3,0,0.1,0.178,0,0.021,0.033,303,0,78,8,4532,0,0]
					];
					dbData.forEach(function(element){
						var obj = {};
						dbFields.forEach(function(column,i){
							obj[column] = element[i];
						});
						fruitsObjectStore.add(obj);
					});
				}
			};
			request.onsuccess = function(event) {
				self.db = request.result;
			};
			this.job('go',this.go);
		},
		go: function(){
			if(this.db){
				if(this.columns.length>0){
					var self = this;
					var objectStore = this.db.transaction(["fruits"], "readonly").objectStore("fruits");
					var index;
					if(this.sortColumn) objectStore = objectStore.index(this.sortColumn);
					var skip = this.start;
					var length = this.length;
					var results = [];
					var direction = this.sortDescending ? "prev" : "next";
					this.openTransactionCount += 2;
					if(!this.loading) this.loading = true;
					objectStore.count().onsuccess = function(event){
						self.dataSize = event.target.result;
						self.openTransactionCount--;
						if(self.openTransactionCount === 0) self.loading = false;
					}
					objectStore.openCursor(null, direction).onsuccess = function(event) {
						var cursor = event.target.result;
						if (cursor && length !== 0) {
							if(skip>0){
								cursor.advance(skip);
								skip = 0;
							}else{
								length--;
								var obj = cursor.value;
								results.push(obj);
								cursor.continue();
							}
						}else{
							self.data = results;
							self.openTransactionCount--;
							if(self.openTransactionCount === 0) self.loading = false;
						}
					};
				};
			}else this.job('go',this.go);
		},
		columnsChanged: function(){ this.job('go',this.go); },
		startChanged: function(){ this.job('go',this.go); },
		lengthChanged: function(){ this.job('go',this.go); },
		sortColumnChanged: function(){ this.job('go',this.go); },
		sortDescendingChanged: function(){ this.job('go',this.go); }
	});
</script>
</polymer-element>
