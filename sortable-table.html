<!--
 https://github.com/stevenrskelton/sortable-table
-->

<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="json-5.html">

<polymer-element name="sortable-table" attributes="
	data columns sortColumn sortDescending rowSelection multiSelect selected selectedRowStyle
	headerTemplate cellTemplate rowTemplate footerTemplate checkbox pageSize page
	rowEditorTemplate disableColumnMove theme
">
<template>
	<style>
		.sortable-table {
			width: inherit;
			border-collapse: collapse;
		}
	</style>
	<template if="{{theme=='extjs'}}">
		<style>
			/* th
			x-unselectable x-column-header x-unselectable-default x-column-header-align-left x-box-item x-column-header-first

			element {
				width: 286px;
				margin: 0px;
				height: auto;
				left: 0px;
				top: 0px;
			}*/
			tbody tr:nth-of-type(even) td,
			.x-grid-row-alt .x-grid-cell,.x-grid-row-alt .x-grid-rowwrap-div{
				background-color:#fafafa
			}
			.x-panel-default-framed{
				border-color:#99bbe8;
				-moz-border-radius:4px;
				-webkit-border-radius:4px;
				-o-border-radius:4px;
				-ms-border-radius:4px;
				-khtml-border-radius:4px;
				border-radius:4px;
				padding:4px 4px 0px 4px;
				border-width:1px;
				border-style:solid;
				background-color:#dfe8f6;
			}
			.x-border-box .x-reset, .x-border-box .x-reset * {
				box-sizing: border-box;
			}
			.x-box-item {
				position: absolute !important;
				left: 0px;
				top: 0px;
			}
			.x-unselectable {
				-moz-user-select: none;
			}
			.x-column-header-align-left {
				text-align: left;
			}
			th.sortable-table-header,
			.x-column-header{
				padding:0;
				/*position:absolute;*/
				overflow:hidden;
				border-right:1px solid #c5c5c5;
				border-left:0 none;
				border-top:0 none;
				border-bottom:0 none;
				text-shadow:0 1px 0 rgba(255, 255, 255, 0.3);
				font:normal 14px tahoma, arial, verdana, sans-serif;
				background-image:none;
				background-color:#c5c5c5;
				background-image:-webkit-gradient(linear, 50% 0%, 50% 100%, color-stop(0%, #f9f9f9), color-stop(100%, #e3e4e6));
				background-image:-moz-linear-gradient(top, #f9f9f9,#e3e4e6);
				background-image:linear-gradient(top, #f9f9f9,#e3e4e6)
			}
			.x-border-box .x-reset, .x-border-box .x-reset * {
				box-sizing: border-box;
			}
			tr,
			.x-grid-row {
				line-height: 13px;
				vertical-align: top;
				padding: 0px 1px;
				-moz-user-select: none;
			}
			.x-grid-table {
				border-collapse: separate;
			}
			table {
				border-collapse: collapse;
				border-spacing: 0px;
				font:normal 14px tahoma, arial, verdana, sans-serif;
			}
			tbody,
			.x-panel .x-grid-body{
				background:white;
				border-color:#99bbe8;
				border-style:solid;
				border-width:1px;
				border-top-color:#c5c5c5
			}
			.x-panel-body-default-framed {
				color: #000;
			}
			tbody tr,
			.x-grid-row{
				line-height:13px;
				vertical-align:top;
				padding:0 1px;
				-moz-user-select:none;
				-khtml-user-select:none;
				-webkit-user-select:ignore
			}
			tbody tr td,
			.x-grid-row .x-grid-cell{
				color:null;
				border-color:#ededed;
				border-style:solid;
				border-width:1px 0;
				border-top-color:#fafafa
			}
			thead tr:first-of-type,
			.x-grid-header-ct{
				cursor:default;
				zoom:1;
				padding:0;
				border:1px solid #99bbe8;
				background-image:none;
				background-color:#c5c5c5;
				background-image:-webkit-gradient(linear, 50% 0%, 50% 100%, color-stop(0%, #f9f9f9), color-stop(100%, #e3e4e6));
				background-image:-moz-linear-gradient(top, #f9f9f9,#e3e4e6);
				background-image:linear-gradient(top, #f9f9f9,#e3e4e6)
			}
			.x-grid-rowwrap-div{
				border-width:1px 0;
				border-color:#ededed;
				border-style:solid;
				border-top-color:#fafafa;
				overflow:hidden
			}
			.x-grid-row-over .x-grid-cell,.x-grid-row-over .x-grid-rowwrap-div{
				border-color:#dddddd;
				background-color:#efefef
			}
			.x-grid-row-focused .x-grid-cell,.x-grid-row-focused .x-grid-rowwrap-div{
				border-color:#dddddd;
				background-color:#efefef
			}
			.sortable-table-selected-row td,
			.x-grid-row-selected .x-grid-cell,.x-grid-row-selected .x-grid-rowwrap-div{
				border-style:dotted;
				border-color:#a3bae9;
				background-color:#dfe8f6 !important
			}
			th.sortable-table-header-selected,
			.x-column-header-over,.x-column-header-sort-ASC,.x-column-header-sort-DESC{
				border-left-color:#aaccf6;
				border-right-color:#aaccf6;
				background-image:none;
				background-color:#aaccf6;
				background-image:-webkit-gradient(linear, 50% 0%, 50% 100%, color-stop(0%, #ebf3fd), color-stop(39%, #ebf3fd), color-stop(40%, #d9e8fb), color-stop(100%, #d9e8fb));
				background-image:-moz-linear-gradient(top, #ebf3fd,#ebf3fd 39%,#d9e8fb 40%,#d9e8fb);
				background-image:linear-gradient(top, #ebf3fd,#ebf3fd 39%,#d9e8fb 40%,#d9e8fb)
			}
			.sortable-table-paging {
				font:normal 12px tahoma, arial, verdana, sans-serif;
				color: #4c4c4c;
				cursor:auto;
			}
			th.over-right {
				border-right-color: #FBBA37;
				background: #FBBA37; /* Older browsers */
				background: -moz-linear-gradient(left, #ebedec 50%, #FBBA37 100%); /* FF3.6+ */
				background: -webkit-linear-gradient(left, #ebedec 50%, #FBBA37 100%); /* Chrome10+,Safari5.1+ */
				background: -o-linear-gradient(left, #ebedec 50%, #FBBA37 100%); /* Opera 11.10+ */
				background: -ms-linear-gradient(left, #ebedec 50%, #FBBA37 100%); /* IE10+ */
				background: linear-gradient(left, #ebedec 50%, #FBBA37 100%); /* W3C */
			}
			th.over-left {
				border-left-color: #FBBA37;
				background: #FBBA37; /* Older browsers */
				background: -moz-linear-gradient(left, #FBBA37 0%, #ebedec 50%); /* FF3.6+ */
				background: -webkit-linear-gradient(left, #FBBA37 0%, #ebedec 50%); /* Chrome10+,Safari5.1+ */
				background: -o-linear-gradient(left, #FBBA37 0%, #ebedec 50%); /* Opera 11.10+ */
				background: -ms-linear-gradient(left, #FBBA37 0%, #ebedec 50%); /* IE10+ */
				background: linear-gradient(left, #FBBA37 0%, #ebedec 50%); /* W3C */
			}
			</style>
	</template>
	<template if="{{theme==''}}">
		<style>
			tr:nth-of-type(even) {
				background-color: rgba(255,255,224,0.25);
			}
			.sortable-table-header,
			th {
				background: #0084B4;
				color: white;
				font-weight: bold;
				text-align: center;
			}
			.sortable-table-paging td,
			.sortable-table-footer {
				background: #F5F8FA;
				font-weight: bold;
			}
			td, th {
				padding: 6px;
				border: 1px solid #ccc;
			}
			th {
				text-align: center;
				cursor: pointer;
			}
			th.over-right {
				border-right-color: #FBBA37;
				background: #FBBA37; /* Older browsers */
				background: -moz-linear-gradient(left, #0084B4 50%, #FBBA37 100%); /* FF3.6+ */
				background: -webkit-linear-gradient(left, #0084B4 50%, #FBBA37 100%); /* Chrome10+,Safari5.1+ */
				background: -o-linear-gradient(left, #0084B4 50%, #FBBA37 100%); /* Opera 11.10+ */
				background: -ms-linear-gradient(left, #0084B4 50%, #FBBA37 100%); /* IE10+ */
				background: linear-gradient(left, #0084B4 50%, #FBBA37 100%); /* W3C */
			}
			th.over-left {
				border-left-color: #FBBA37;
				background: #FBBA37; /* Older browsers */
				background: -moz-linear-gradient(left, #FBBA37 0%, #0084B4 50%); /* FF3.6+ */
				background: -webkit-linear-gradient(left, #FBBA37 0%, #0084B4 50%); /* Chrome10+,Safari5.1+ */
				background: -o-linear-gradient(left, #FBBA37 0%, #0084B4 50%); /* Opera 11.10+ */
				background: -ms-linear-gradient(left, #FBBA37 0%, #0084B4 50%); /* IE10+ */
				background: linear-gradient(left, #FBBA37 0%, #0084B4 50%); /* W3C */
			}
		</style>
	</template>
	<template id="defaultPaging">
		<div style="text-align:center">
			<div style="float:left;cursor:pointer;color:{{page==1 ? '#AAA':'#000'}}" on-click="{{moveToPreviousPage}}">Prev</div>
			<div style="float:right;cursor:pointer;color:{{page * pageSize > data.length ? '#AAA':'#000'}}" on-click="{{moveToNextPage}}">Next</div>
			Page {{page}} of {{lastPage}}
		</div>
	</template>
	<table class="sortable-table">
		<thead>
			<tr on-click="{{changeSort}}">
				<template if="{{checkbox}}">
					<th style="width:1em"><input type="checkbox" on-change="{{checkall}}" hidden?="{{!multiSelect}}" checked?="{{data.length==selected.length}}"></th>
				</template>
				<template repeat="{{column in columns}}">
					<template ref="{{column.headerTemplate || headerTemplate}}" bind>
						<th
							draggable="{{!disableColumnMove && !(rowTemplate || rowEditorTemplate)}}"
							class="sortable-table-header {{sortColumn==column.name ? 'sortable-table-header-selected' : ''}}"
							style="{{sortColumn==column.name && sortDescending ? 'text-decoration:overline;' : ''}} {{sortColumn==column.name && !sortDescending ? 'text-decoration:underline;' : ''}}"
							on-dragstart="{{handleTHDragStart}}"
							on-dragenter="{{handleTHDragEnter}}"
							on-dragover="{{handleTHDragOver}}"
							on-dragleave="{{handleTHDragLeave}}"
							on-drop="{{handleTHDrop}}"
							on-dragend="{{handleTHDragEnd}}"
						>{{!(column.title) ? column.name : column.title}}</th>
					</template>
				</template>
			</tr>
		</thead>
		<tbody>
			<template repeat="{{record in data | sortByKey(sortColumn, sortDescending, columns, selected, pageSize, page, editRow, (selected || []).length + data.length, forceRefresh)}}">
				<tr
					on-click="{{rowSelect}}"
					on-dblclick="{{rowEdit}}"
					style="{{record.selected && selectedRowStyle ? selectedRowStyle : ''}}"
					class="{{record.selected ? 'sortable-table-selected-row' : '' }}"
				>
					<template if="{{checkbox}}">
						<td><input type="checkbox" on-change="{{checkedbox}}" checked?="{{record.selected}}"></td>
					</template>
					<template if="{{record.edit}}" ref="{{rowEditorTemplate}}">
					</template>
					<template if="{{!record.edit}}" ref="{{rowTemplate}}" bind>
						<template repeat="{{column in columns}}">
							<template ref="{{column.cellTemplate || cellTemplate}}" bind="{{record.fields[column.name]}}">
								<td>{{value}}</td>
							</template>
						</template>
					</template>
				</tr>
			</template>
		</tbody>
		<tfoot>
			<template if="{{showFooter && forceFooterRefresh}}">
				<tr>
					<template if="{{checkbox}}">
						<td></td>
					</template>
					<template repeat="{{column in columns}}">
						<template bind="{{templateData in data | selectProperty(column, forceFooterRefresh)}}">
							<template ref="{{column.footerTemplate}}" bind="{{templateData}}">
								<td class="sortable-table-footer" style="border:0;"></td>
							</template>
						</template>
					</template>
				</tr>
			</template>
			<template if="{{footerTemplate && forceRefresh && forceFooterRefresh}}">
				<tr class="sortable-table-paging">
					<td colspan="{{columns.length + (checkbox ? 1 : 0)}}"><template ref="{{footerTemplate}}" bind></template></td>
				</tr>
			</template>
		</tfoot>
	</table>
</template>

<script>
	"use strict";
	Polymer('sortable-table', {
		sortColumn: null,
		sortDescending: false,
		disableColumnMove: false,
		selected: null,
		editRow: null,
		headerTemplate: null,
		footerTemplate: null,
		rowTemplate: null,
		rowEditorTemplate: null,
		pageSize: Number.MAX_VALUE,
		page: 1,
		lastPage: 1,
		theme: '',
		changeSort: function(e,p){
			if(e.target.templateInstance.model.column){
				var clickedSortColumn = e.target.templateInstance.model.column.name;
				if(clickedSortColumn == this.sortColumn){
					//column already sorted, reverse sort
					this.sortDescending = !this.sortDescending;
				}else{
					this.sortColumn = clickedSortColumn;
				}
			}
		},
		selectedRowStyle: 'background-color:rgba(0,96,200,0.2);',
		rowSelection: false,
		multiSelect: false,
		rowEdit: function(e,p){
			if(this.rowEditorTemplate){
				var model = e.target.templateInstance.model;
				var row = model.row;
				if(model.record) row = model.record.row;
				if(this.editRow != row){
					this.originalEditRow = JSON.parse(JSON.stringify(row));
					this.editRow = row;
				}
			}
		},
		closeEdit: function(e){
			this.originalEditRow = null;
			this.editRow = null;
		},
		undoEdit: function(e){
			if(this.originalEditRow && this.editRow){
				var self = this;
				Object.getOwnPropertyNames(this.originalEditRow).forEach(function(val, idx, array) {
					if(self.editRow[val] !== self.originalEditRow[val] && self.originalEditRow[val] != undefined)
						self.editRow[val] = self.originalEditRow[val];
				});
				this.refreshFooter();
			}
		},
		cancelEdit: function(e){
			this.undoEdit.call(this, e); this.closeEdit.call(this, e);
		},
		rowSelect: function(e,p){
			if(this.rowSelection && e.target.templateInstance && e.target.nodeName!='INPUT'){
				var model = e.target.templateInstance.model;
				var row = model.row;
				if(model.record) row = model.record.row;
				this.toggleRowFromSelected(row);
			}
		},
		toggleRowFromSelected: function(row){
			if(this.isArray(this.selected)){
				var index = this.selected.indexOf(row);
				if(index>-1){
					this.selected.splice(index, 1);
				}else{
					this.selected.push(row);
				}
			}else{
				if(this.selected == row) this.selected = null;
				else this.selected = row;
			}
		},
		columnWatches: [],
		showFooter: false,
		columnsChanged: function(){
			var self = this;
			//explode columns if simple text array
			if(self.columns.length > 0 && typeof self.columns[0] == 'string'){
				self.columns = self.columns.map(function(column, index, array) {
					return { name: index, title: column };
				});
			}
			//watch templateIds since if added/modified we need to copy those templates into the shadow dom
			function addTemplateWatches(column, field){
				for(var i=0;i<self.columnWatches.length;i++){
					if(self.columnWatches[i].object_==column && self.columnWatches[i].path_[0]==field) return;
				}
				var observer = new PathObserver(c, field);
				self.columnWatches.push(observer);
				observer.open(function(added, removed, changed, getOldValueFn) {
					self.columnsChanged();
				});
			}
			for(var i=0;i<this.columns.length;i++){
				var c = this.columns[i];
				this.addTemplateIfNotInDocument(c.cellTemplate);
				this.addTemplateIfNotInDocument(c.headerTemplate);
				this.addTemplateIfNotInDocument(c.footerTemplate);
				if(c.footerTemplate) this.showFooter = true;
				addTemplateWatches(c,'cellTemplate');
				addTemplateWatches(c,'headerTemplate');
				addTemplateWatches(c,'footerTemplate');
			}
			this.forceRefresh++;
		},
		dataChanged: function(){ this.rebuildColumns(); this.pageSizeChanged(); },
		rebuildColumns: function(){
			if(this.columns.length==0 && this.data && this.data.length > 0){
				//try and load from DOM
				var columnNodes = this.querySelectorAll('sortable-column');
				var c = [];
				var self = this;
				if(columnNodes.length>0){
					[].forEach.call(columnNodes, function(n, index) {
						var name = n.getAttribute('name');
						if(!name || name == '') name = index;
						var title = n.getAttribute('title');
						if(!title || title == '') title = n.textContent.trim();
						if(title == '') title = name;
						var formula = n.getAttribute('formula');
						if(formula){
							var match = formula.match(/function[^\(]*\(([^\)]*)\)[^\{]*{([^\}]*)\}/);
							if (match) {
								var args = match[1].split(',').map(function(arg) { return arg.replace(/\s+/, ''); });
								formula = new Function(args, match[2]);
							}else if(self[formula]){
								//not an inlined function, assume it's a member of this
								formula = self[formula]
							}else if(PolymerExpressions.prototype[formula]){
								//not an inlined function, or member of this, check PolymerExpressions.prototype
								formula = PolymerExpressions.prototype[formula];
							}else alert('Could not load formula `'+ formula +'` for column `' + name + '`');
						}
						c.push({
							name: name, title: title, formula: formula,
							cellTemplate: n.getAttribute('cellTemplate'),
							headerTemplate: n.getAttribute('headerTemplate'),
							footerTemplate: n.getAttribute('footerTemplate')
						});
					});
					this.columns = c;
					this.columnsChanged();
				}else{
					var unique = [];
					for(var i=0;i<this.data.length;i++){
						Object.keys(this.data[i]).forEach(function(property) {
							if (unique.indexOf(property)==-1) {
								unique.push(property);
								c.push({name: property});
							}
						});
					}
					this.columns = c;
				}
			}
		},
		rowSelectionChanged: function(a,val){
			var table = this.shadowRoot.querySelector('table')
			if(table) table.style.cursor=(val ? 'pointer' : 'auto');
		},
		multiSelectChanged: function(a,val){
			if(val){
				if(!this.isArray(this.selected)){
					if(this.selected) this.selected = [this.selected];
					else this.selected = [];
				}
			}else if(this.isArray(this.selected)){
				if(this.selected.length > 0) this.selected = this.selected[0];
				else this.selected = null;
			}
		},
		selectedChanged: function(a,val){
			if(val!=undefined){
				if(this.isArray(val)){
					if(!this.multiSelect) this.multiSelect = true;
				}else{
					if(this.multiSelect) this.multiSelect = false;
				}
			}
		},
		cellTemplateChanged: function(a, t){
			this.addTemplateIfNotInDocument(t);
		},
		rowTemplateChanged: function(a, t){
			this.addTemplateIfNotInDocument(t);
		},
		headerTemplateChanged: function(a, t){
			this.addTemplateIfNotInDocument(t);
			this.forceRefresh++;
		},
		footerTemplateChanged: function(a, t){
			this.addTemplateIfNotInDocument(t);
			this.forceRefresh++;
		},
		rowEditorTemplateChanged: function(a, t){
			this.addTemplateIfNotInDocument(t);
		},
		addTemplateIfNotInDocument: function(templateId){
			/* copy template from content into shadow dom */
			if(templateId && this.shadowRoot && !this.shadowRoot.getElementById(templateId)){
				var t = this.querySelector('#'+templateId);
				if(t) this.shadowRoot.appendChild(t);
				else alert('Could not find template `' + templateId + '`');
			}
		},
		checkbox: false,
		checkedbox: function(e,p){
			var row = e.target.templateInstance.model.record.row;
			this.toggleRowFromSelected(row);
			e.preventDefault();
		},
		checkall: function(e,p){
			if(e.target.checked){
				for(var i=0;i<this.data.length;i++){
					if(this.selected.indexOf(this.data[i])==-1) this.selected.push(this.data[i]);
				}
			}else{
				this.selected = [];
			}
		},
		moveToPreviousPage: function(){ if(this.page > 1) this.page--; },
		moveToNextPage: function(){ if(this.data.length > this.page * this.pageSize) this.page++; },
		moveToFirstPage: function(){ this.page = 1; },
		moveToLastPage: function(){ this.page = this.lastPage; },
		pageSizeChanged: function(){
			this.lastPage = Math.max(1,Math.ceil(this.data.length / this.pageSize));
		},
		created: function(){
			if(!this.data) this.data = [];
			if(!this.columns) this.columns = [];
		},
		ready: function(){
			var array = [];
			var self = this;
			[].forEach.call(this.childNodes, function(element) {
				if(element.nodeName == "#text"){
					var text = element.textContent.trim();
					if(text.length>0){
						var data;
						try{
							data = JSON.parse(text);
						} catch(e){
							try {
								data = JSON5.parse(text);
							} catch(e){
								alert('Could not parse data.\n\nArrays, JSON and JSON5 are supported.');
							}
						}
						if(data){
							self.data = data;
							self.rebuildColumns();
						}else self.data = [];
					}
				}
			});
			this.onMutation(this, this.ready);
		},
		/**
		 *	Column Drag-and-Drop
		 */
		dragColumn: null,
		handleTHDragStart: function(e) {
			if(!this.disableColumnMove && !(this.rowTemplate || this.rowEditorTemplate)){
				this.dragColumn = {
					th: e.target,
					column: e.target.templateInstance.model.column,
					opacity: e.target.style.opacity,
					entered: null,
					index: this.columns.indexOf(e.target.templateInstance.model.column)
				},
				e.target.style.opacity = '0.4';
				e.dataTransfer.effectAllowed = 'move';
				e.dataTransfer.setData('application/sortable-table-column-name', this.dragColumn.index);
			}
		},
		handleTHDragOver: function(e) {
			if (e.preventDefault) e.preventDefault(); // Necessary. Allows us to drop.
			e.dataTransfer.dropEffect = 'move';
			this.handleTHDragEnter(e);
			return false;
		},
		findDropSide: function(e,self){
			var th = e.target;
			var index = self.columns.indexOf(th.templateInstance.model.column);
			if((index < self.dragColumn.index - 1) || (index > self.dragColumn.index + 1)){
				if(th.getBoundingClientRect){
					var center = th.clientWidth/2 + th.getBoundingClientRect().left;
					return (center >= e.clientX) ? -1 : 1;
				}else return 0;
			}else if(index == self.dragColumn.index - 1){
				return -1;
			}else if(index == self.dragColumn.index + 1){
				return 1;
			}
		},
		handleTHDragEnter: function(e) {
			if(this.dragColumn){
				var th = e.target;
				this.dragColumn.entered = null;
				while(th.tagName!='TH' && th.parentElement){
					th = th.parentElement;
					if(th.tagName=='TH') this.dragColumn.entered = th;
				}
				var dragSide = this.findDropSide(e,this);
				if(dragSide<0){
					th.classList.remove('over-right');
					th.classList.add('over-left');
				}else if(dragSide>0){
					th.classList.remove('over-left');
					th.classList.add('over-right');
				}
			}
		},
		handleTHDragLeave: function(e) {
			if(this.dragColumn){
				var th = e.target;
				if(this.dragColumn.entered == th) this.dragColumn.entered == null;
				else if(th.classList){
					if(th.classList.contains('over-left')) th.classList.remove('over-left');
					if(th.classList.contains('over-right')) th.classList.remove('over-right');
				}
			}
		},
		handleTHDrop: function(e) {
			if (e.stopPropagation) e.stopPropagation(); // stops the browser from redirecting.
			if(this.dragColumn && this.dragColumn.th.parentNode == e.target.parentNode){
				var newIndex = this.columns.indexOf(e.target.templateInstance.model.column);
				var oldIndex = +e.dataTransfer.getData('application/sortable-table-column-name');
				var dragSide = this.findDropSide(e,this);
				if(newIndex < oldIndex && dragSide == 1) newIndex++;
				else if(newIndex > oldIndex && dragSide == -1) newIndex--;
				if(newIndex != oldIndex){
					var b = this.columns.splice(oldIndex,1);
					this.columns.splice(newIndex,0,b[0]);
				}
			}
			return false;
		},
		handleTHDragEnd: function(e) {
			if(this.dragColumn){
				this.dragColumn.th.style.opacity = this.dragColumn.opacity;
				[].forEach.call(this.shadowRoot.querySelectorAll('th'), function(element) {
					element.classList.remove('over-left');
					element.classList.remove('over-right');
				});
			}
			this.dragColumn = null;
		},
		/**
		 *	Template Functions
		 */
		isArray: function(a){
			return Object.prototype.toString.call(a)==='[object Array]';
		},
		sortByKey: function(array, key, desc, columns, selected, pageSize, page, editRow, l) {
			//ignore l, it is used to trigger observe.js watch only
			var sortedArray = array.sort(function(a, b) {
				var x, y;
				//determine if computed field
				var formula = null;
				for(var i=0;i<columns.length;i++){
					if(columns[i].name===key){
						formula = columns[i].formula;
						break;
					}
				}
				if(formula){
					x = formula(a);
					y = formula(b);
				}else{
					x = a[key];
					y = b[key];
				}

				if(typeof x == 'undefined' || typeof y == 'undefined'){
					//sort undefined after
					if(typeof x == 'undefined'){
						return !desc;
					}else{
						return desc;
					}
				}else{
					if (typeof x == "string" && typeof y == "string" && !(x == +x && y == +y)){
						x = x.toLowerCase();
						y = y.toLowerCase();
					}
					if(desc){
						return ((x < y) ? 1 : ((x > y) ? -1 : 0));
					}else{
						return ((x < y) ? -1 : ((x > y) ? 1 : 0));
					}
				}
			});
			var records = [];
			var isMultiSelect = this.isArray(selected);

			if(page < 1) page = 1;

			var start = (pageSize < Number.MAX_VALUE) ? Math.min(pageSize * (page - 1), sortedArray.length) : 0;
			var end = (pageSize < Number.MAX_VALUE) ? Math.min(start + +pageSize, sortedArray.length) : sortedArray.length;

			for(var i=start;i<end;i++){
				var row = sortedArray[i];
				var isSelected = isMultiSelect ? selected.indexOf(row) > -1 : row == selected;
				var isEditMode = editRow == row
				var fields = {};
				columns.forEach(function(column, index, array) {
					var value;
					if(column.formula){
						value = column.formula(row);
					}else{
						value = row[column.name];
					}
					fields[column.name] = { value: value, row: row, column: column };
				});
				records.push({ selected: isSelected, edit: isEditMode, fields: fields, row: row });
			}
			return records;
		},
		selectProperty: function(objects, column) {
			var arr = [];
			var rowArr = [];
			for(var i=0;i<objects.length;i++){
				var row = objects[i];
				var value;
				if(column.formula){
					value = column.formula(row);
				}else{
					value = row[column.name];
				}
				rowArr.push(row[column.name]);
				arr.push(value);
			}
			return { values: arr, rowValues: rowArr, column: column };
		},
		/**
		  *	TODO: clean this up, it was put in to trigger a reprocess on initial load when templates are imported into the shadow dom.
		  */
		forceRefresh: 0,
		forceFooterRefresh: 1,
		refreshFooter: function(){ this.forceFooterRefresh++; }
	});
</script>
</polymer-element>
